name: Build WanGP Portable

on:
  push:
    branches:
      - portable-release
  workflow_dispatch:

jobs:
  build-portable:
    runs-on: windows-latest
    env:
      PYTHON_VERSION: 3.10.9
      TORCH_INDEX: https://download.pytorch.org/whl/test/cu128

    steps:
      # 1ï¸âƒ£ Checkout repo
      - uses: actions/checkout@v4
        with:
          ref: portable-release
          
      - name: Clone another repo
        run: git clone https://github.com/deepbeepmeep/Wan2GP.git

      # 2ï¸âƒ£ Download Python Embedded
      - name: Download Python Embedded
        run: |
          curl -L -o python-embed.zip https://www.python.org/ftp/python/${{ env.PYTHON_VERSION }}/python-${{ env.PYTHON_VERSION }}-embed-amd64.zip
          mkdir python_embedded
          tar -xf python-embed.zip -C python_embedded
          
          # Uncomment import site and add site-packages path
          (Get-Content python_embedded\python310._pth) -replace '# import site','import site' | Set-Content python_embedded\python310._pth
          Add-Content python_embedded\python310._pth "Lib\site-packages"
          
          # Create folders for packages
          mkdir python_embedded\Lib\site-packages

      # 3ï¸âƒ£ Install pip directly into Lib\site-packages
      - name: Install pip
        run: |
          curl -L -o get-pip.py https://bootstrap.pypa.io/get-pip.py
          python_embedded\python.exe get-pip.py --no-warn-script-location --target=python_embedded/Lib/site-packages
          python_embedded\python.exe -m pip --version

      # 4ï¸âƒ£ Install core dependencies (Torch, SageAttention)
      - name: Install Torch and SageAttention
        run: |
          python_embedded\python.exe -m pip install --upgrade pip --target=python_embedded/Lib/site-packages
          python_embedded\python.exe -m pip install --upgrade --target=python_embedded/Lib/site-packages torch==2.8.0 torchvision torchaudio --index-url ${{ env.TORCH_INDEX }}
          python_embedded\python.exe -m pip install --upgrade --target=python_embedded/Lib/site-packages triton-windows
          python_embedded\python.exe -m pip install --upgrade --target=python_embedded/Lib/site-packages https://github.com/woct0rdho/SageAttention/releases/download/v2.2.0-windows.post2/sageattention-2.2.0+cu128torch2.8.0.post2-cp39-abi3-win_amd64.whl

      # 5ï¸âƒ£ Install FilterPy
      - name: Install FilterPy
        run: |
          python_embedded\python.exe -m pip install --target=python_embedded/Lib/site-packages https://www.piwheels.org/simple/filterpy/filterpy-1.4.5-py3-none-any.whl

      # 6ï¸âƒ£ Install remaining requirements
      - name: Install requirements
        run: |
          python_embedded\python.exe -m pip install --upgrade --target=python_embedded/Lib/site-packages -r Wan2GP/requirements.txt

      - name: Prepare portable folder and package
        run: |
          mkdir WanGP-Portable
          copy Launch_WanGP.bat WanGP-Portable\
          robocopy python_embedded WanGP-Portable\python_embedded /E /COPYALL
          IF %ERRORLEVEL% GEQ 8 exit /b %ERRORLEVEL%  
          robocopy Wan2GP WanGP-Portable\Wan2GP /E /COPYALL    
          7z a -t7z -m0=lzma2 -mx=9 -md=512m -mfb=273 -ms=on -v2000m "WanGP-Portable.7z" "WanGP-Portable\*" -xr!"__pycache__" -xr!"*.pyc" -xr!".gitignore"
          IF %ERRORLEVEL% NEQ 0 exit /b %ERRORLEVEL%

        # 9ï¸âƒ£ Daily tag based on current date
      - name: Create tag
        id: tag
        shell: pwsh
        run: |
          $date = (Get-Date).ToString("yyyy-MM-dd")
          $new_tag = "v$date"
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git fetch --tags
          if (git tag -l $new_tag) {
            Write-Host "Tag $new_tag already exists, skipping creation."
          } else {
            git tag $new_tag
            git push origin $new_tag
          }
          echo "new_tag=$new_tag" >> $env:GITHUB_OUTPUT

      # ðŸ”Ÿ Create GitHub release
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.tag.outputs.new_tag }}
          files: WanGP-Portable.7z.*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
