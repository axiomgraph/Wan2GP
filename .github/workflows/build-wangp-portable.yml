name: Build WanGP Portable

on:
  push:
    branches:
      - portable-release  # branch for portable builds
  workflow_dispatch:

jobs:
  build-portable:
    runs-on: windows-latest
    env:
      PYTHON_VERSION: 3.10.9
      TORCH_INDEX: https://download.pytorch.org/whl/test/cu128

    steps:
      # 1ï¸âƒ£ Checkout the repo
      - name: Checkout
        uses: actions/checkout@v4

      # 2ï¸âƒ£ Download and set up Python Embedded
      - name: Download Python Embedded
        run: |
          curl -L -o python-embed.zip https://www.python.org/ftp/python/${{ env.PYTHON_VERSION }}/python-${{ env.PYTHON_VERSION }}-embed-amd64.zip
          mkdir python_embedded
          tar -xf python-embed.zip -C python_embedded
          
          # Uncomment 'import site' in _pth file
          (Get-Content python_embedded\python310._pth) -replace '# import site','import site' | Set-Content python_embedded\python310._pth
          
          # Create necessary folders for pip
          mkdir python_embedded\Lib\site-packages
          mkdir python_embedded\Scripts

      # 3ï¸âƒ£ Install pip in embedded Python
      - name: Install pip
        run: |
          curl -L -o get-pip.py https://bootstrap.pypa.io/get-pip.py
          python_embedded\python.exe get-pip.py --prefix=python_embedded
          python_embedded\python.exe -m pip --version

      # 4ï¸âƒ£ Install core dependencies (Torch, SageAttention)
      - name: Install Torch and SageAttention
        run: |
          python_embedded\python.exe -m pip install --upgrade pip
          python_embedded\python.exe -m pip install --target=python_embedded/Lib/site-packages torch==2.8.0 torchvision torchaudio --index-url ${{ env.TORCH_INDEX }}
          python_embedded\python.exe -m pip install --target=python_embedded/Lib/site-packages triton-windows
          python_embedded\python.exe -m pip install --target=python_embedded/Lib/site-packages https://github.com/woct0rdho/SageAttention/releases/download/v2.2.0-windows.post2/sageattention-2.2.0+cu128torch2.8.0.post2-cp39-abi3-win_amd64.whl

      # 5ï¸âƒ£ Install FilterPy
      - name: Install FilterPy
        run: |
          python_embedded\python.exe -m pip install --target=python_embedded/Lib/site-packages https://www.piwheels.org/simple/filterpy/filterpy-1.4.5-py3-none-any.whl

      # 6ï¸âƒ£ Install remaining requirements
      - name: Install requirements
        run: |
          python_embedded\python.exe -m pip install --target=python_embedded/Lib/site-packages -r Wan2GP/requirements.txt

      # 7ï¸âƒ£ Add Launcher and organize portable folder
      - name: Add Launcher
        run: |
          mkdir WanGP-Portable
          copy Launch_WanGP.bat WanGP-Portable\
          xcopy /E /I python_embedded WanGP-Portable\python_embedded
          xcopy /E /I Wan2GP WanGP-Portable\Wan2GP

      # 8ï¸âƒ£ Package into 7-Zip (split archive)
      - name: Package 7-Zip
        run: |
          7z a -t7z -m0=lzma2 -mx=9 -md=512m -mfb=273 -ms=on -v2000m "WanGP-Portable.7z" "WanGP-Portable\*" -xr!"__pycache__" -xr!".git" -xr!".gitignore" -xr!"*.pyc"

      # 9ï¸âƒ£ Auto-increment tag
      - name: Create tag
        id: tag
        run: |
          git fetch --tags
          latest=$(git describe --tags --abbrev=0 2>nul || echo "v0.0.0")
          IFS='.' read -r major minor patch <<< "${latest#v}"
          patch=$((patch+1))
          new_tag="v$major.$minor.$patch"
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git tag $new_tag
          git push origin $new_tag
          echo "new_tag=$new_tag" >> $GITHUB_OUTPUT

      # ðŸ”Ÿ Create GitHub release
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.tag.outputs.new_tag }}
          files: WanGP-Portable.7z.*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
