name: Build Portable WanGP

on:
  workflow_dispatch:
  push:
    branches:
      - portable-release

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout portable branch
        uses: actions/checkout@v4

      - name: Clone upstream Wan2GP
        uses: actions/checkout@v4
        with:
          repository: deepbeepmeep/Wan2GP
          path: Wan2GP
          ref: main

      - name: Download Python Embedded 3.10.9
        shell: pwsh
        run: |
          curl -L -o python_embed.zip https://www.python.org/ftp/python/3.10.9/python-3.10.9-embed-amd64.zip
          Expand-Archive -Path python_embed.zip -DestinationPath python_embedded

      - name: Enable site imports in _pth
        shell: pwsh
        run: |
          $pth = "python_embedded/python310._pth"
          (Get-Content $pth) | ForEach-Object {
            if ($_ -match '^\s*#\s*import site') { 'import site' } else { $_ }
          } | Set-Content $pth -Encoding ascii

      - name: Install pip
        shell: pwsh
        run: |
          curl -L -o get-pip.py https://bootstrap.pypa.io/get-pip.py
          python_embedded/python.exe get-pip.py --no-warn-script-location

      - name: Verify pip
        run: python_embedded/python.exe -m pip --version

      - name: Install Torch 2.8.0 (CUDA 12.8)
        run: >
          python_embedded/python.exe -m pip install torch==2.8.0 torchvision torchaudio
          --index-url https://download.pytorch.org/whl/test/cu128
          --target=python_embedded/Lib/site-packages

      - name: Install Triton
        run: python_embedded/python.exe -m pip install triton-windows --target=python_embedded/Lib/site-packages

      - name: Install SageAttention
        run: >
          python_embedded/python.exe -m pip install
          https://github.com/woct0rdho/SageAttention/releases/download/v2.2.0-windows.post2/sageattention-2.2.0+cu128torch2.8.0.post2-cp39-abi3-win_amd64.whl
          --target=python_embedded/Lib/site-packages

      - name: Install FilterPy (binary only)
        run: python_embedded/python.exe -m pip install --only-binary=:all: filterpy --target=python_embedded/Lib/site-packages

      - name: Install Requirements
        run: python_embedded/python.exe -m pip install -r Wan2GP/requirements.txt --target=python_embedded/Lib/site-packages

      - name: Prepare Portable Folder
        shell: pwsh
        run: |
          mkdir WanGP-Portable
          Copy-Item Launch_WanGP.bat WanGP-Portable\
          Copy-Item -Recurse -Force Wan2GP WanGP-Portable\Wan2GP
          Copy-Item -Recurse -Force python_embedded WanGP-Portable\python_embedded

      - name: Package Portable Version (split 7z)
        shell: pwsh
        run: |
          7z a -t7z -m0=lzma2 -mx=9 -md=512m -mfb=273 -ms=16g -v1000m `
            WanGP-Portable.7z WanGP-Portable\* `
            -xr!__pycache__ -xr!.git -xr!.gitignore -xr!*.pyc

      - name: Upload Split Archives to Release
        uses: softprops/action-gh-release@v1
        with:
          files: WanGP-Portable.7z.*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
